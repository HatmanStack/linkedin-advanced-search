name: Claude Code Review

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} > changed_files.txt
          else
            git diff --name-only HEAD^ HEAD > changed_files.txt
          fi
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          cat changed_files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get code diff
        id: diff
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            DIFF=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            DIFF=$(git diff HEAD^ HEAD)
          fi

          # Truncate diff if too large (Claude has context limits)
          if [ ${#DIFF} -gt 50000 ]; then
            DIFF="${DIFF:0:50000}... [diff truncated due to size]"
          fi

          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Claude Code Review
        id: claude-review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Create review script
          cat > review.js << 'SCRIPT_EOF'
          const https = require('https');

          const apiKey = process.env.ANTHROPIC_API_KEY;
          const diff = process.env.DIFF;
          const changedFiles = process.env.CHANGED_FILES;

          if (!apiKey) {
            console.error('ANTHROPIC_API_KEY is not set');
            process.exit(1);
          }

          const prompt = `You are an expert code reviewer. Review the following code changes and provide:

          1. **Code Quality Issues**: Identify bugs, security vulnerabilities, performance issues, or anti-patterns
          2. **Best Practices**: Suggest improvements following modern JavaScript/TypeScript/Python best practices
          3. **Testing**: Note if tests are missing or inadequate
          4. **Documentation**: Check if changes need documentation updates
          5. **Overall Assessment**: Rate the changes (Approved, Needs Minor Changes, Needs Major Changes)

          Changed files:
          ${changedFiles}

          Code diff:
          \`\`\`diff
          ${diff}
          \`\`\`

          Provide a concise review focusing on the most important issues. Format your response in Markdown.`;

          const data = JSON.stringify({
            model: 'claude-sonnet-4-5-20250929',
            max_tokens: 4096,
            messages: [{
              role: 'user',
              content: prompt
            }]
          });

          const options = {
            hostname: 'api.anthropic.com',
            path: '/v1/messages',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'Content-Length': data.length
            }
          };

          const req = https.request(options, (res) => {
            let body = '';
            res.on('data', (chunk) => body += chunk);
            res.on('end', () => {
              if (res.statusCode === 200) {
                const response = JSON.parse(body);
                const review = response.content[0].text;
                console.log(review);
              } else {
                console.error('API Error:', res.statusCode, body);
                process.exit(1);
              }
            });
          });

          req.on('error', (e) => {
            console.error('Request error:', e);
            process.exit(1);
          });

          req.write(data);
          req.end();
          SCRIPT_EOF

          export DIFF="${{ steps.diff.outputs.diff }}"
          export CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"

          # Run the review and capture output
          REVIEW=$(node review.js)
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post review comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = `${{ steps.claude-review.outputs.review }}`;

            const comment = `## ðŸ¤– Claude Code Review

            ${review}

            ---
            *Automated review by Claude Sonnet 4.5*`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Post review as commit comment
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = `${{ steps.claude-review.outputs.review }}`;

            const comment = `## ðŸ¤– Claude Code Review

            ${review}

            ---
            *Automated review by Claude Sonnet 4.5*`;

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });

      - name: Upload review as artifact
        uses: actions/upload-artifact@v4
        with:
          name: claude-review-${{ github.sha }}
          path: |
            changed_files.txt
          retention-days: 30
